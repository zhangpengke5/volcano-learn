## Volcanoè°ƒåº¦å™¨çš„"Capacity"æ’ä»¶ï¼šé›†ç¾¤èµ„æºçš„æ™ºèƒ½ç®¡å®¶

åœ¨Kubernetesé›†ç¾¤ä¸­ç®¡ç†å¤šä¸ªå›¢é˜Ÿå…±äº«èµ„æºæ—¶ï¼Œå¦‚ä½•å…¬å¹³åˆ†é…èµ„æºï¼Ÿå¦‚ä½•ç¡®ä¿æ¯ä¸ªå›¢é˜Ÿéƒ½æœ‰è¶³å¤Ÿçš„èµ„æºè¿è¡Œå…³é”®ä»»åŠ¡ï¼Ÿè¿™å°±æ˜¯Volcanoè°ƒåº¦å™¨çš„**Capacityæ’ä»¶**è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚æœ¬æ–‡å°†å¸¦æ‚¨æ·±å…¥äº†è§£è¿™ä¸ªé›†ç¾¤èµ„æºçš„æ™ºèƒ½ç®¡å®¶å¦‚ä½•å·¥ä½œã€‚

---

### ğŸ—ï¸ ä»€ä¹ˆæ˜¯Capacityæ’ä»¶ï¼Ÿ
Capacityæ’ä»¶æ˜¯Volcanoè°ƒåº¦å™¨çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£**é˜Ÿåˆ—çº§åˆ«çš„èµ„æºé…é¢ç®¡ç†**ã€‚æƒ³è±¡ä¸€ä¸ªå¤§å‹ä¼ä¸šçš„ITéƒ¨é—¨ï¼š
- **é›†ç¾¤èµ„æº**ï¼šå…¬å¸æ€»é¢„ç®—
- **é˜Ÿåˆ—**ï¼šä¸åŒéƒ¨é—¨ï¼ˆç ”å‘éƒ¨ã€å¸‚åœºéƒ¨ç­‰ï¼‰
- **ä»»åŠ¡**ï¼šå„éƒ¨é—¨çš„é¡¹ç›®

Capacityæ’ä»¶å°±æ˜¯è´¢åŠ¡æ€»ç›‘ï¼Œç¡®ä¿ï¼š
1. æ¯ä¸ªéƒ¨é—¨ä¸è¶…é¢„ç®—
2. å…³é”®éƒ¨é—¨æœ‰æœ€ä½ä¿éšœ
3. ç´§æ€¥é¡¹ç›®èƒ½è·å¾—é¢å¤–èµ„æº

---

### ğŸŒ³ æ ¸å¿ƒæ¶æ„ï¼šå±‚æ¬¡åŒ–é˜Ÿåˆ—ç³»ç»Ÿ

æ¯ä¸ªé˜Ÿåˆ—éƒ½æœ‰ä¸‰ä¸ªå…³é”®å±æ€§ï¼š
1. **Capability**ï¼šèµ„æºä¸Šé™ï¼ˆéƒ¨é—¨é¢„ç®—ä¸Šé™ï¼‰
2. **Guarantee**ï¼šä¿éšœèµ„æºï¼ˆéƒ¨é—¨æœ€ä½ä¿éšœï¼‰
3. **Deserved**ï¼šåº”å¾—èµ„æºï¼ˆæ ¹æ®éœ€æ±‚åŠ¨æ€è®¡ç®—ï¼‰

---

### âš™ï¸ æ ¸å¿ƒæœºåˆ¶è§£æ

#### 1. **èµ„æºè·Ÿè¸ª - å®æ—¶ä¼šè®¡ç³»ç»Ÿ**
æ’ä»¶ç»´æŠ¤æ¯ä¸ªé˜Ÿåˆ—çš„èµ„æºè´¦æœ¬ï¼š
```go
type queueAttr struct {
    allocated  *api.Resource // å·²åˆ†é…èµ„æºï¼ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼‰
    request    *api.Resource // æ€»è¯·æ±‚èµ„æºï¼ˆåŒ…æ‹¬ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼‰
    inqueue    *api.Resource // æ’é˜Ÿä¸­çš„èµ„æºéœ€æ±‚
    elastic    *api.Resource // å¼¹æ€§èµ„æºï¼ˆå¯å›æ”¶éƒ¨åˆ†ï¼‰
}
```
å°±åƒè´¢åŠ¡ç³»ç»Ÿå®æ—¶è·Ÿè¸ªï¼š
- å·²æ”¯å‡ºé‡‘é¢ï¼ˆallocatedï¼‰
- å·²å®¡æ‰¹é¢„ç®—ï¼ˆinqueueï¼‰
- å¯è°ƒæ•´é¢„ç®—ï¼ˆelasticï¼‰

#### 2. **å¤šå±‚èµ„æºæ ¡éªŒ - ä¸¥æ ¼çš„è´¢åŠ¡å®¡æ‰¹**
å½“æ–°ä»»åŠ¡ç”³è¯·èµ„æºæ—¶ï¼Œæ’ä»¶ä¼šè¿›è¡Œå¤šå±‚æ£€æŸ¥ï¼š

```go
func (cp *capacityPlugin) checkQueueAllocatableHierarchically(...) bool {
    // ä»å¶å­é˜Ÿåˆ—é€çº§å‘ä¸Šæ£€æŸ¥åˆ°æ ¹é˜Ÿåˆ—
    for i := len(list)-1; i >= 0; i-- {
        if !cp.queueAllocatable(...) {
            return false // ä»»ä¸€å±‚çº§ä¸æ»¡è¶³å³æ‹’ç»
        }
    }
    return true
}
```
è¿™å°±åƒå¤§é¢é‡‡è´­éœ€è¦éƒ¨é—¨ä¸»ç®¡â†’æ€»ç›‘â†’CFOå±‚å±‚å®¡æ‰¹ã€‚

#### 3. **åŠ¨æ€èµ„æºåˆ†é… - æ™ºèƒ½é¢„ç®—è°ƒæ•´**
æ ¹æ®å®é™…éœ€æ±‚åŠ¨æ€è®¡ç®—é˜Ÿåˆ—åº”å¾—èµ„æºï¼š
```go
// è®¡ç®—é€»è¾‘ç®€åŒ–ç‰ˆ
deserved = min(
    capability,      // ä¸è¶…è¿‡ä¸Šé™
    max(
        guarantee,   // ä¸ä½äºä¿éšœ
        request     // æ»¡è¶³å®é™…éœ€æ±‚
    )
)
```

---

### ğŸš¦ å››å¤§æ ¸å¿ƒåŠŸèƒ½

#### 1. **ä»»åŠ¡è°ƒåº¦å‡†å…¥æ§åˆ¶ï¼ˆAddAllocatableFnï¼‰**
```go
ssn.AddAllocatableFn(cp.Name(), func(queue *api.QueueInfo, candidate *api.TaskInfo) bool {
    return cp.checkQueueAllocatableHierarchically(ssn, queue, candidate)
})
```
- **ä½œç”¨**ï¼šæ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¯åˆ†é…åˆ°é˜Ÿåˆ—
- **è§„åˆ™**ï¼š`(å·²åˆ†é… + æ–°ä»»åŠ¡) â‰¤ é˜Ÿåˆ—èƒ½åŠ›`

#### 2. **ä½œä¸šå…¥é˜Ÿæ§åˆ¶ï¼ˆAddJobEnqueueableFnï¼‰**
```go
ssn.AddJobEnqueueableFn(cp.Name(), func(obj interface{}) int {
    return cp.checkJobEnqueueableHierarchically(ssn, queue, job)
})
```
- **ä½œç”¨**ï¼šå†³å®šä½œä¸šèƒ½å¦è¿›å…¥è°ƒåº¦é˜Ÿåˆ—
- **è§„åˆ™**ï¼š`(å·²åˆ†é… + æ’é˜Ÿä¸­ - å¼¹æ€§èµ„æº) â‰¤ é˜Ÿåˆ—èƒ½åŠ›`

#### 3. **èµ„æºå›æ”¶æœºåˆ¶ï¼ˆAddReclaimableFnï¼‰**
```go
ssn.AddReclaimableFn(cp.Name(), func(reclaimer *api.TaskInfo, reclaimees []*api.TaskInfo) (...) {
    // é€‰æ‹©å¯å›æ”¶çš„ä»»åŠ¡
})
```
- **åœºæ™¯**ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡éœ€è¦èµ„æºæ—¶
- **è§„åˆ™**ï¼šä¼˜å…ˆå›æ”¶è¶…è¿‡ä¿éšœèµ„æºçš„ä»»åŠ¡

#### 4. **æŠ¢å å†³ç­–ï¼ˆAddPreemptiveFnï¼‰**
```go
ssn.AddPreemptiveFn(cp.Name(), func(obj interface{}, candidate interface{}) bool {
    futureUsed := allocated + candidateèµ„æº
    return futureUsed â‰¤ deserved // ä¸è¶…è¿‡åº”å¾—èµ„æºæ‰å…è®¸æŠ¢å 
})
```
- **ä½œç”¨**ï¼šå†³å®šä»»åŠ¡æ˜¯å¦å¯è¢«æŠ¢å 
- **è§„åˆ™**ï¼šæŠ¢å åé˜Ÿåˆ—èµ„æºä¸è¶…è¿‡åº”å¾—èµ„æº

---

### ğŸ“Š å®æ—¶èµ„æºç›‘æ§

æ’ä»¶é€šè¿‡Prometheusæš´éœ²å…³é”®æŒ‡æ ‡ï¼š
```go
metrics.UpdateQueueDeserved(...)    // é˜Ÿåˆ—åº”å¾—èµ„æº
metrics.UpdateQueueAllocated(...)   // å·²åˆ†é…èµ„æº
metrics.UpdateQueueRequest(...)     // æ€»è¯·æ±‚èµ„æº
metrics.UpdateQueueShare(...)       // èµ„æºä½¿ç”¨ç‡
```
è¿ç»´äººå‘˜å¯ä»¥ç›‘æ§ï¼š
- å“ªäº›é˜Ÿåˆ—èµ„æºç´§å¼ 
- å“ªäº›é˜Ÿåˆ—èµ„æºé—²ç½®
- é›†ç¾¤æ•´ä½“åˆ©ç”¨ç‡

---

### ğŸ› ï¸ å®é™…åº”ç”¨åœºæ™¯

#### æ¡ˆä¾‹1ï¼šä¿éšœæ ¸å¿ƒä¸šåŠ¡
```yaml
# æ”¯ä»˜é˜Ÿåˆ—-é«˜ä¿éšœ
apiVersion: scheduling.volcano.sh/v1beta1
kind: Queue
metadata:
  name: payment
spec:
  capability: 
    cpu: "32"
    memory: 64Gi
  guarantee:
    cpu: "16"
    memory: 32Gi
```

#### æ¡ˆä¾‹2ï¼šé™åˆ¶ä¸´æ—¶ä»»åŠ¡
```yaml
# æµ‹è¯•é˜Ÿåˆ—-æ— ä¿éšœ
apiVersion: scheduling.volcano.sh/v1beta1
kind: Queue
metadata:
  name: testing
spec:
  capability: 
    cpu: "8"
    memory: 16Gi
```

#### æ¡ˆä¾‹3ï¼šå¤šå±‚èµ„æºåˆ†é…
```yaml
# ç ”å‘éƒ¨çˆ¶é˜Ÿåˆ—
apiVersion: scheduling.volcano.sh/v1beta1
kind: Queue
metadata:
  name: dev-department
spec:
  capability: 
    cpu: "64"
    memory: 128Gi

---
# åç«¯å­é˜Ÿåˆ—
apiVersion: scheduling.volcano.sh/v1beta1
kind: Queue
metadata:
  name: backend-team
  parent: dev-department # æŒ‡å®šçˆ¶é˜Ÿåˆ—
spec:
  capability: 
    cpu: "32"
    memory: 64Gi
```

---

### âš ï¸ å…³é”®é”™è¯¯å¤„ç†

æ’ä»¶ä¸¥æ ¼æ£€æŸ¥é˜Ÿåˆ—å±‚çº§åˆç†æ€§ï¼š
```go
func (cp *capacityPlugin) checkHierarchicalQueue(attr *queueAttr) error {
    // æ£€æŸ¥çˆ¶é˜Ÿåˆ—èƒ½åŠ›â‰¥å­é˜Ÿåˆ—æ€»å’Œ
    if parentCapability < childTotal {
        return fmt.Errorf("çˆ¶é˜Ÿåˆ—èƒ½åŠ›ä¸è¶³")
    }
    // æ£€æŸ¥ä¿éšœèµ„æºä¸€è‡´æ€§
    if parentGuarantee < childGuarantees {
        return fmt.Errorf("çˆ¶é˜Ÿåˆ—ä¿éšœèµ„æºä¸è¶³")
    }
}
```
ç¡®ä¿ä¸ä¼šå‡ºç°ï¼š
- å­é˜Ÿåˆ—é¢„ç®—è¶…è¿‡çˆ¶éƒ¨é—¨
- ä¿éšœèµ„æºåˆ†é…å†²çª

---

### ğŸ’¡ è®¾è®¡äº®ç‚¹

1. **å±‚æ¬¡åŒ–èµ„æºç®¡ç†**  
   æ”¯æŒä¼ä¸šçº§çš„å¤šå±‚èµ„æºåˆ†é…ç»“æ„

2. **åŠ¨æ€èµ„æºè°ƒæ•´**  
   æ ¹æ®å®é™…éœ€æ±‚åŠ¨æ€è®¡ç®—åº”å¾—èµ„æº

3. **å¼¹æ€§èµ„æºå›æ”¶**  
   æ™ºèƒ½è¯†åˆ«å¯å›æ”¶çš„éå…³é”®ä»»åŠ¡èµ„æº

4. **å…¨é“¾è·¯èµ„æºè·Ÿè¸ª**  
   ä»ä»»åŠ¡æäº¤åˆ°è¿è¡Œå…¨ç¨‹ç›‘æ§

5. **Prometheusé›†æˆ**  
   æä¾›å®æ—¶èµ„æºç›‘æ§æŒ‡æ ‡

---

### ğŸŒŸ æ€»ç»“
Volcanoçš„Capacityæ’ä»¶å¦‚åŒé›†ç¾¤èµ„æºçš„æ™ºèƒ½ç®¡å®¶ï¼š
1. **èµ„æºä¼šè®¡**ï¼šç²¾ç¡®è·Ÿè¸ªæ¯ä¸ªé˜Ÿåˆ—çš„èµ„æºä½¿ç”¨
2. **é¢„ç®—æ§åˆ¶**ï¼šä¸¥æ ¼æ‰§è¡Œèµ„æºé…é¢é™åˆ¶
3. **çµæ´»åˆ†é…**ï¼šå¹³è¡¡ä¿éšœéœ€æ±‚ä¸å¼¹æ€§éœ€æ±‚
4. **å¤šå±‚ç®¡ç†**ï¼šæ”¯æŒå¤æ‚ç»„ç»‡ç»“æ„
5. **æ™ºèƒ½å›æ”¶**ï¼šä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡


è®©æ‚¨çš„Kubernetesé›†ç¾¤èµ„æºåˆ†é…æ—¢å…¬å¹³åˆé«˜æ•ˆï¼